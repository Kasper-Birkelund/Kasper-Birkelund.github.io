---
layout: post
title: Coding challenge
---
<!--<img src="/images/fulls/01.jpg" class="fit image">-->
Answers to the coding challenge.

# Part 1

## What is the total amount of BTC recorded on the blockchain?

The BTC UTXO-set is an ever changing dataset comprising all the unspend outputs (or ballance) for each BTC address. You can simply calculate your wallet address ballance by summing up the UTXOs available for your address.
So the the total circulating amount of BTC on the blockchain has to be the sum of all UTXOs.

I decided to use BigQuery's built in workbench to run this query:

```sql
SELECT
  SUM(outputs.value) / 100000000  -- 1 BTC = 100.000.000 sats
FROM
  `bigquery-public-data.crypto_bitcoin.transactions`,
  UNNEST(outputs) AS outputs
WHERE
  block_timestamp_month <= "2010-01-01"
```

and get this result:

**2271014.35**

The nested structs concept is new to me, but I understand it is a smart way of optimizing the execution of a query, by not having to join tables together as you usually would.

I found later that I could also just have run this query:

```sql
SELECT
  SUM(output_value) / 100000000
FROM
  `bigquery-public-data.crypto_bitcoin.transactions`
WHERE
  block_timestamp_month <= "2010-01-01"
```

It seems the outputs are both in the main transaction table and in the outputs struct.

The result of about 2.27 million BTC seems to be a reasonable result.  However, when I look at the graph on [Blockchain.com](https://www.blockchain.com/charts/total-bitcoins) it shows that only around 1.6 million BTC is mined by 1st of January 2010. It states below the chart that it is created based on the theoretical amount mined as defined by the mathematics of the protocol.
I remember reading somewhere that we are ahead of schedule with the mining so I am fairly confident that this is correct.


## What is the amount of **unspent** BTC which were created in coinbase transactions?
(In other words, we are interested in knowing the amount of mining rewards, that have never left the mining address.)

Coinbase transactions are mining rewards generated by nodes for each block they succesfully finish. Not to be confused with coinbase.com transactions except that they chose the company name from this.

To calculate this, we just need to add an extra filter (is_coinbase = TRUE) so we get only the coinbase UTXOs:

```sql
SELECT
  SUM(outputs.value) / 100000000
FROM
  `bigquery-public-data.crypto_bitcoin.transactions`,
  UNNEST(outputs) AS outputs
WHERE
  block_timestamp_month <= "2010-01-01"
  AND is_coinbase = TRUE
```

**Result: 1874703.13 or about 1.87 million**

We can then conclude that around 82,5% of all circulating BTC was in the hands of the miners by 1st of january 2010.

## Bonus question: Time series for unspend supply

If this was sales data, as I am used to working with, I would simple group on what date interval you want to look at. In this case the month as it is readily availabe as a column. To look at it daily I would parse the block_timestamp and extract year, month and day.

```sql
SELECT
  block_timestamp_month,
  SUM(outputs.value) / 100000000
FROM
  `bigquery-public-data.crypto_bitcoin.transactions`,
  UNNEST(outputs) AS outputs
WHERE
  block_timestamp_month <= "2010-01-01"
GROUP BY
  block_timestamp_month
ORDER BY
  block_timestamp_month ASC
  ```

Afterwards I would create a cumulative sum and plot it to get a graph like the one on blockchain.com I linked to.

You can of course calculate the cumulative sum in database with SQL as well, but that part is not very computational heavy and would be easier to do in python and Dataiku for me.
At FrieslandCampina I would keep the SQL query effeciently simple and load the data as raw as possible into Dataiku and use Dataiku's processors or pandas dataframes from there.
However, working with blockchain data I might have to get used to doing more in database calculations due the the size of the dataset.

A quick copy past into Excel to do the cumulative sum and plot gives this:

![png](/images/Coding-challenge/cumulative.png)

I am not 100% sure this is correct, as my understanding of the UTXO-set is that it is continuously being changed to reflect the current state of the blockchain.
So to get the the exact amount it circulating BTC at an earlier point in time you would have to have a snapshot of the UTXO-set at that time?

I assume the BigQuery bitcoin UTXO-set is only the current one?



# Part 2

